# UI/入力/送信フロー レビュー：問題リスト

**目的**: 最短で「公開できる状態」にする（時間↓/ミス↓/手戻り↓）  
**方針**: 提案→確認→実装の順。大規模改修は行わず、まず議論用。

---

## 1) 問題リスト（重要度順・最大10件）

### Critical

#### C1. 本登録（full-register）：必須エラー時に「該当項目へスクロール＆フォーカス」していない
- **ページ**: `full-register.html`
- **問題**: 必須未入力で送信すると `#errorBox`（画面上部）へだけ `scrollIntoView` しており、**実際に赤枠の付いた入力欄（例：振込口座・口座名義）へスクロール・フォーカスしていない**。長いフォームで下部の項目が不足していると、ユーザーは「何が足りないか」を探し回る。
- **推奨対応**:
  - `validate()` の戻り値に「最初の不正な要素」を追加する（例: `{ ok: false, msg: "...", firstInvalidEl: element }`）。
  - 送信ハンドラで `firstInvalidEl` に対して `scrollIntoView({ behavior: "smooth", block: "center" })` と `focus({ preventScroll: false })` を実行する。
- **影響**: 必須漏れの修正に時間がかかり、離脱や誤送信のリスクが増える。

---

#### C2. 仮登録・本登録（main-register）で `mode: "no-cors"` のため送信結果を判定できない
- **ページ**: `register.html`, `main-register.html`
- **問題**: `fetch(ENDPOINT, { method: "POST", mode: "no-cors", ... })` を使用しているため **レスポンス body が opaque で読めない**。GAS が 500 やバリデーションエラーを返してもフロントでは「通信完了」としか分からず、**失敗時も「送信しました」や thankyou へ遷移してしまう**。
- **推奨対応**:
  - **仮登録（register）**: 可能なら `mode: "no-cors"` を外し、`res.json()` で `ok` を確認してから成功表示。CORS が張られていれば GAS は既に JSON を返しているので、設定次第で対応可。
  - **本登録（main-register）**: 同様にレスポンスを読んで、`ok === true` のときだけ thankyou へリダイレクトし、失敗時はエラーバナー＋メッセージ表示。
- **影響**: 送信失敗なのに「完了」とユーザーが思い、運営に問い合わせが集中する。データ欠損に気づくのが遅れる。

---

#### C3. 本登録で送信した振込口座データが GAS 側シートに保存されていない
- **ページ/ファイル**: `gas/Code.gs`（本登録シート行の構成）
- **問題**: フロントは `data.bankAccount`（銀行/ゆうちょの入力）を送っているが、GAS の `handleDriverFullRegister` でシートに書き込んでいるのは `receiptId, date, fullName, address, age, city_public, vehicle_public, experience, tools, message, status, linePushed, lineError` および URL 列のみ。**bankAccount はどこにも保存されていない**。
- **推奨対応**:
  - 本登録シートに「振込口座」用の列を追加（1列に JSON 文字列でも、または銀行名・支店・口座番号・名義などを個別列でも可）。
  - `data.bankAccount` を取得し、文字列化または分解して該当列に書き込む。
- **影響**: 振込時に口座情報がシートに残らず、運用で困る。

---

### High

#### H1. full-register：同意チェックのエラー表示が弱い
- **ページ**: `full-register.html`
- **問題**: 同意未チェック時は `agree.classList.add("is-invalid")` のみ。チェックボックスは枠が小さいため、**どこがエラーか分かりにくい**。
- **推奨対応**: 同意ラベル（または直下）に、他の項目と同様の「その場で目立つメッセージ」（例: `.field-error-text` で「同意にチェックを入れてください」）を表示する。可能ならラベルに `is-invalid` を付与して色・枠で強調。
- **影響**: 同意漏れのまま何度も送信しようとして混乱する。

---

#### H2. main-register：郵便番号の形式チェック・住所自動入力がない
- **ページ**: `main-register.html`
- **問題**: 郵便番号は「必須」のみで **7桁チェックやハイフン除去がない**。また full-register にあるような「住所を自動入力」や都道府県/市区町村の連動がない。
- **推奨対応**:
  - 郵便番号は `input` で数字のみ・最大7桁に制限し、バリデーションで「7桁で入力してください」と出す。
  - 余力があれば zipcloud（または同一API）で都道府県・市区町村を補完（full-register と共通化してもよい）。
- **影響**:  typo や形式不備で住所が届かず、本人確認で手戻りが増える。

---

#### H3. ページ読み込み時のフラッシュ（一瞬の見え方の変化）
- **ページ**: 全ページ（`assets/transition.js` + `assets/effects.css`）
- **問題**: `transition.js` が DOMContentLoaded 後に `html` に `is-enter` を付与し、`effects.css` の `pageEnter` が **opacity 0 → 1** で始まる。そのため、**一瞬コンテンツが消えたように見えてからフェードインする**可能性がある（環境によっては「白っぽく一瞬光る」と感じる場合もある）。
- **推奨対応**:
  - 初回表示では `is-enter` を最初から付与する（HTML の `html` に `class="is-enter"` を付ける）、または
  - アニメーションを「opacity 1 のまま」にし、blur だけにする、もしくは `prefers-reduced-motion` と同様にアニメーションなしをデフォルトにする。
- **影響**: 体感として「壊れてる？」「チカチカする」と感じるユーザーがいる。

---

### Medium

#### M1. 仮登録：メールの形式チェックがブラウザ任せのみ
- **ページ**: `register.html`
- **問題**: `contactEmail` は `type="email"` で HTML5 チェックに依存。**日本語のエラーメッセージや「どれが不足か」の一覧には出てこない**。また「メール or LINE表示名のどちらか必須」は実装されているが、メールを選んだ場合の形式（@ を含む等）はバリデーションで明示していない。
- **推奨対応**: 送信前の `buildPayload_` 内で、メールが入力されている場合は簡易的な形式チェック（正規表現で @ とドメインらしき部分）を行い、NG なら「メールアドレスを正しく入力してください」と `addFieldError_` で表示する。
- **影響**:  typo したメールで登録され、連絡が届かない。

---

#### M2. full-register：口座名義カナの形式チェックがない
- **ページ**: `full-register.html`
- **問題**: 口座名義（カナ）は半角→全角変換のみで、**カタカナ以外（英数字・漢字）の混在を許している**。銀行によってはカナのみ受け付けるため、後で振込失敗する可能性がある。
- **推奨対応**: バリデーションで「カタカナ（・スペース）のみ」をチェックし、違反時は「口座名義はカタカナで入力してください」のように具体的に表示する。
- **影響**: 振込時にはじかれて運営側で修正依頼が発生する。

---

#### M3. thankyou ページ：「次に何をすればいいか」がやや抽象的
- **ページ**: `thankyou.html`
- **問題**: 「運営確認後にご連絡します」と受付ID・追跡IDはあるが、**「この画面をスクショして保管してください」「連絡がない場合は LINE でお問い合わせください」** など、次のアクションがもう一歩書いてあると親切。
- **推奨対応**: 短い文言で「受付IDは控えておいてください」「しばらく連絡がない場合は LINE からお問い合わせください」などを追加する。
- **影響**: 不安になり、同じ内容を再送したり問い合わせが増えたりする。

---

### Low

#### L1. 銀行口座：ゆうちょの「記号・番号」を出さない方針は既に満たしている
- **ページ**: `full-register.html`
- **問題**: 特になし。振込用（店名/店番3桁/口座番号7桁/名義カナ）のみで、記号・番号は入力項目に含めていない。口座写真アップロードもなし。
- **推奨**: 現状のままでよい。必要なら「振込用の情報だけ入力してください」という注意を一行強化しても可。
- **影響**: なし（良い状態）。

---

## 2) すぐ直せる「最短の修正」で必要なファイル

- **C1 対応**: `full-register.html` のみ（`validate()` の戻り値拡張と、submit 内での `firstInvalidEl` へのスクロール・フォーカス追加）。
- **C2 対応**: `register.html`, `main-register.html`（`mode: "no-cors"` 削除とレスポンス解析・エラー表示。GAS の CORS が有効であることが前提）。
- **C3 対応**: `gas/Code.gs`（本登録シートの列追加と `data.bankAccount` の書き込み）。
- **H1 対応**: `full-register.html`（同意まわりに `.field-error-text` とラベル `is-invalid`）。
- **H2 対応**: `main-register.html`（郵便番号の制限・バリデーション、必要なら zip  lookup の組み込み）。
- **H3 対応**: `assets/transition.js` と `assets/effects.css`（初回表示のアニメーション見直し）。
- **M1 対応**: `register.html`（メール形式チェック追加）。
- **M2 対応**: `full-register.html`（口座名義カナの形式チェック）。
- **M3 対応**: `thankyou.html`（文言追加）。

**コードは今回出さず、議論・優先順位の確認後に「ファイルごと全文」で出す前提**とします。

---

## 3) その他「普通だったらこうする」指摘（UI/文言/導線/必須）

- **必須ラベルの統一**: 「必須」「必須です」が混在。ラベルは「必須」、エラー文言は「〇〇を入力してください」「〇〇を選択してください」に揃えると読みやすい。
- **送信ボタンの二重送信防止**: full-register は送信中に `submitBtn.disabled = true` で防いでいるが、main-register / register も同様に送信開始直後に無効化し、完了 or エラーで再度有効化する方が安全（現状も一応あるが、no-cors のため「完了」判定が不正確な問題とセット）。
- **ファイルサイズ超過時のメッセージ**: full-register は「ファイルが大きすぎます（上限 5MB）。：ファイル名」のように出している。コロンが全角だったり、ファイル名だけだと「どの項目か」が分かりにくいので、「〇〇（例：免許証表）のファイルが大きすぎます。5MB以内に圧縮してください」のように項目名を含めると親切。
- **スマホでのタップ領域**: 送信ボタン・「住所を自動入力」ボタンは `py-2` などで十分な高さがあるが、ラジオ「通常の銀行」「ゆうちょ」はもう少しクリック領域を広げてもよい（padding やラベル全体をタップ可能にする）。
- **エラーバナーの位置**: full-register はフォーム直上に固定で良いが、スクロールして「どこが赤枠か」が画面外にある場合、エラーメッセージに「振込口座の〇〇を確認してください」のように**項目名を明示**すると、ユーザーが探しやすい。
- **本登録と full-register の役割の違い**: index やリンクでは「本登録（案内された方）」が full-register、「本登録（main-register）」は別ルート。運用で「どちらを案内するか」が分かるよう、案内文や noindex の説明を一言そろえておくと、誤って main-register に来た人にも分かりやすい。
- **仮登録の「LINEで内容を送る」**: 送信失敗時のフォールバックとして有用。成功時にも「届いていない場合はこちらから送り直してください」と一言あると安心。
- **GAS の bankAccountProof**: フロントは口座写真を送っていない。GAS の `FULL_REGISTER_FILE_KEYS` に `bankAccountProof` が含まれているが、送らなければスキップされるだけなので問題ない。口座は「入力のみ」で運用するなら、GAS 側で bankAccount をシートに書く（C3）が必須。

以上です。優先度の希望（例：C1→C3→C2 の順で直したい等）があれば教えてください。該当ファイルの具体的な修正案（必要なら全文）は次のステップで出します。
